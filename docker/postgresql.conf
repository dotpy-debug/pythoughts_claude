# ==============================================================================
# PostgreSQL 16 Production Configuration for Pythoughts
# ==============================================================================
#
# HARDWARE ASSUMPTIONS:
#   - CPU: 2-4 cores
#   - RAM: 4-8 GB
#   - Storage: SSD
#
# WORKLOAD TYPE: Mixed OLTP (read-heavy with moderate writes)
#
# TUNING PHILOSOPHY:
#   - Optimized for reliability and performance
#   - Conservative settings to prevent OOM
#   - Suitable for production workloads
#
# ==============================================================================

# ==============================================================================
# CONNECTION SETTINGS
# ==============================================================================

# Maximum number of concurrent connections
max_connections = 100

# Reserved connections for superuser
superuser_reserved_connections = 3

# ==============================================================================
# MEMORY SETTINGS
# ==============================================================================

# Shared memory buffer (25% of system RAM)
# For 4GB RAM = 1GB, for 8GB RAM = 2GB
shared_buffers = 1GB

# Memory for complex sorts and hash tables (2-4% of RAM per connection)
work_mem = 16MB

# Memory for maintenance operations (10% of RAM)
maintenance_work_mem = 256MB

# Total memory for autovacuum workers
autovacuum_work_mem = 256MB

# Maximum memory for SQL execution
effective_cache_size = 3GB

# Temporary buffers for each session
temp_buffers = 8MB

# ==============================================================================
# WRITE AHEAD LOG (WAL)
# ==============================================================================

# WAL level for replication and point-in-time recovery
wal_level = replica

# Minimum size to keep for replication
min_wal_size = 1GB

# Maximum size before forced checkpoint
max_wal_size = 4GB

# WAL segment size
wal_segment_size = 16MB

# WAL buffers (-1 = auto, typically 1/32 of shared_buffers)
wal_buffers = 16MB

# Sync method (fdatasync is default and fast on Linux)
wal_sync_method = fdatasync

# Commit delay for group commits (microseconds)
commit_delay = 0

# Minimum concurrent commits before delay
commit_siblings = 5

# Enable WAL compression
wal_compression = on

# Archive mode (enable for backups)
archive_mode = on
archive_command = '/bin/true'  # Replace with actual archive command
archive_timeout = 3600  # Force WAL switch every hour

# ==============================================================================
# CHECKPOINTS
# ==============================================================================

# Target for checkpoint completion (0.0 - 1.0)
checkpoint_completion_target = 0.9

# Time between automatic checkpoints (seconds)
checkpoint_timeout = 15min

# Warning threshold for checkpoints (0 = off)
checkpoint_warning = 30s

# Flush dirty pages in background
checkpoint_flush_after = 256kB

# ==============================================================================
# QUERY PLANNER
# ==============================================================================

# Planner's assumption about effective cache size
effective_cache_size = 3GB

# Random page cost (lower for SSD)
random_page_cost = 1.1

# Effective I/O concurrency (number of simultaneous I/O operations)
effective_io_concurrency = 200

# Maximum parallel workers per query
max_parallel_workers_per_gather = 2

# Maximum parallel maintenance workers
max_parallel_maintenance_workers = 2

# Maximum parallel workers
max_parallel_workers = 4

# Default statistics target (10-10000, higher = better estimates but slower)
default_statistics_target = 100

# ==============================================================================
# AUTOVACUUM
# ==============================================================================

# Enable autovacuum
autovacuum = on

# Maximum number of autovacuum workers
autovacuum_max_workers = 3

# Naptime between autovacuum runs
autovacuum_naptime = 1min

# Minimum number of row updates before vacuum
autovacuum_vacuum_threshold = 50

# Minimum number of row updates before analyze
autovacuum_analyze_threshold = 50

# Fraction of table size before vacuum
autovacuum_vacuum_scale_factor = 0.1

# Fraction of table size before analyze
autovacuum_analyze_scale_factor = 0.05

# Vacuum cost delay (milliseconds)
autovacuum_vacuum_cost_delay = 2ms

# Vacuum cost limit
autovacuum_vacuum_cost_limit = 200

# Freeze age before aggressive vacuum
autovacuum_freeze_max_age = 200000000

# Multixact age before aggressive vacuum
autovacuum_multixact_freeze_max_age = 400000000

# ==============================================================================
# BACKGROUND WRITER
# ==============================================================================

# Background writer delay between rounds
bgwriter_delay = 200ms

# Maximum number of buffers written per round
bgwriter_lru_maxpages = 100

# Fraction of LRU buffers to scan per round
bgwriter_lru_multiplier = 2.0

# Flush after this many bytes
bgwriter_flush_after = 512kB

# ==============================================================================
# LOGGING
# ==============================================================================

# Where to log
log_destination = 'stderr'

# Logging collector
logging_collector = on

# Log directory
log_directory = 'log'

# Log filename pattern
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# Truncate logs on rotation
log_truncate_on_rotation = on

# Log rotation age (1 day)
log_rotation_age = 1d

# Log rotation size (0 = disabled)
log_rotation_size = 100MB

# What to log
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000  # Log queries taking more than 1s

# Connection logging
log_connections = on
log_disconnections = on

# Session metadata in logs
log_line_prefix = '%t [%p]: user=%u,db=%d,app=%a,client=%h '

# Log lock waits
log_lock_waits = on

# Log temp files above this size
log_temp_files = 10MB

# Log autovacuum activity
log_autovacuum_min_duration = 0

# Log checkpoints
log_checkpoints = on

# Statement logging
log_statement = 'ddl'  # Log DDL statements

# Log slow queries duration
log_duration = off

# ==============================================================================
# PERFORMANCE MONITORING
# ==============================================================================

# Track activity statistics
track_activities = on

# Track I/O timing (adds overhead)
track_io_timing = on

# Track function calls
track_functions = all

# Track activity query size
track_activity_query_size = 4096

# ==============================================================================
# LOCKS
# ==============================================================================

# Maximum locks per transaction
max_locks_per_transaction = 64

# Maximum predicate locks per transaction
max_pred_locks_per_transaction = 64

# Deadlock timeout (milliseconds)
deadlock_timeout = 1s

# ==============================================================================
# REPLICATION
# ==============================================================================

# Maximum wal senders (for replication)
max_wal_senders = 10

# Maximum replication slots
max_replication_slots = 10

# Synchronous commit (on = safest, off = fastest)
synchronous_commit = on

# Time before wal sender timeout (milliseconds)
wal_sender_timeout = 60s

# Keep WAL segments for replication
wal_keep_size = 1GB

# ==============================================================================
# SECURITY
# ==============================================================================

# SSL (configure if using SSL)
ssl = off
# ssl_cert_file = 'server.crt'
# ssl_key_file = 'server.key'
# ssl_ca_file = 'root.crt'

# Password encryption
password_encryption = scram-sha-256

# ==============================================================================
# LOCALE AND FORMATTING
# ==============================================================================

# Locale provider
locale_provider = 'libc'

# Date/time format
datestyle = 'iso, mdy'

# Interval style
intervalstyle = 'postgres'

# Timezone
timezone = 'UTC'

# LC settings
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'

# Default text search configuration
default_text_search_config = 'pg_catalog.english'

# ==============================================================================
# RESOURCE USAGE (BEYOND MEMORY)
# ==============================================================================

# Maximum files per process
max_files_per_process = 1000

# ==============================================================================
# ERROR HANDLING
# ==============================================================================

# Exit on postmaster crash
restart_after_crash = on

# ==============================================================================
# NOTES
# ==============================================================================
#
# TUNING FOR DIFFERENT WORKLOADS:
#
# 1. READ-HEAVY:
#    - Increase shared_buffers
#    - Increase effective_cache_size
#    - Lower random_page_cost (SSD)
#
# 2. WRITE-HEAVY:
#    - Increase wal_buffers
#    - Increase checkpoint_completion_target
#    - Increase max_wal_size
#
# 3. ANALYTICAL:
#    - Increase work_mem
#    - Increase maintenance_work_mem
#    - Increase max_parallel_workers
#
# MONITORING:
#
#   SELECT * FROM pg_stat_database;
#   SELECT * FROM pg_stat_user_tables;
#   SELECT * FROM pg_stat_activity;
#   SELECT * FROM pg_stat_bgwriter;
#
# FURTHER READING:
#
#   - https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server
#   - https://pgtune.leopard.in.ua/
#   - PostgreSQL documentation
#
# ==============================================================================
