# Change Detection Rules
# Defines patterns for intelligent CI/CD optimization

version: 1.0.0

# File pattern definitions
patterns:
  # Documentation files
  documentation:
    - '**/*.md'
    - '**/docs/**/*'
    - '**/README*'
    - '**/CHANGELOG*'
    - '**/LICENSE*'
    - '**/.github/**/*.md'
    description: 'Documentation and markdown files'

  # Configuration files (non-code)
  config:
    - '**/.editorconfig'
    - '**/.prettierrc*'
    - '**/.eslintrc*'
    - '**/tsconfig*.json'
    - '**/.gitignore'
    - '**/.env.example'
    - '**/.nvmrc'
    description: 'Configuration files that don\'t affect runtime'

  # Source code files
  code:
    - 'src/**/*.{ts,tsx,js,jsx}'
    - 'app/**/*.{ts,tsx,js,jsx}'
    - 'pages/**/*.{ts,tsx,js,jsx}'
    - 'components/**/*.{ts,tsx,js,jsx}'
    - 'lib/**/*.{ts,tsx,js,jsx}'
    - 'utils/**/*.{ts,tsx,js,jsx}'
    - 'hooks/**/*.{ts,tsx,js,jsx}'
    - 'services/**/*.{ts,tsx,js,jsx}'
    description: 'Application source code'

  # Database related files
  database:
    - '**/migrations/**/*'
    - '**/db/schema.ts'
    - '**/database/**/*'
    - '**/drizzle/**/*'
    - '**/prisma/**/*'
    - '**/*migration*'
    - '**/*schema.sql'
    - '**/*seed*'
    description: 'Database migrations and schemas'

  # Redis/Cache related files
  cache:
    - '**/redis/**/*'
    - '**/cache/**/*'
    - '**/lib/redis.ts'
    - '**/lib/cache.ts'
    - '**/services/cache*'
    description: 'Redis and caching logic'

  # API routes and endpoints
  api:
    - '**/api/**/*'
    - '**/routes/**/*'
    - '**/controllers/**/*'
    - '**/actions/**/*'
    description: 'API endpoints and server actions'

  # Tests
  tests:
    - '**/*.test.{ts,tsx,js,jsx}'
    - '**/*.spec.{ts,tsx,js,jsx}'
    - '**/tests/**/*'
    - '**/__tests__/**/*'
    - '**/e2e/**/*'
    description: 'Test files'

  # Styles
  styles:
    - '**/*.css'
    - '**/*.scss'
    - '**/*.sass'
    - '**/*.less'
    - '**/tailwind.config.*'
    - '**/postcss.config.*'
    description: 'Stylesheets and styling configuration'

  # Infrastructure and deployment
  infrastructure:
    - '**/Dockerfile*'
    - '**/docker-compose*.yml'
    - '**/.github/workflows/**/*'
    - '**/vercel.json'
    - '**/netlify.toml'
    - '**/scripts/**/*'
    description: 'Infrastructure and deployment files'

  # Package dependencies
  dependencies:
    - '**/package.json'
    - '**/package-lock.json'
    - '**/yarn.lock'
    - '**/pnpm-lock.yaml'
    description: 'Package dependencies'

# Content analysis keywords
contentKeywords:
  database:
    imports:
      - 'drizzle-orm'
      - 'prisma'
      - '@supabase/supabase-js'
      - 'postgres'
      - 'pg'
      - 'mysql'
      - 'mongodb'
      - 'sequelize'
      - 'typeorm'
    keywords:
      - 'createTable'
      - 'dropTable'
      - 'migration'
      - 'schema'
      - 'database'
      - 'db.execute'
      - 'db.query'
      - 'db.select'
      - 'db.insert'
      - 'db.update'
      - 'db.delete'

  cache:
    imports:
      - 'ioredis'
      - 'redis'
      - 'cache-manager'
      - 'node-cache'
    keywords:
      - 'redis.get'
      - 'redis.set'
      - 'redis.del'
      - 'cache.get'
      - 'cache.set'
      - 'getOrSet'
      - 'invalidate'

  api:
    keywords:
      - 'export async function GET'
      - 'export async function POST'
      - 'export async function PUT'
      - 'export async function DELETE'
      - 'app.get('
      - 'app.post('
      - 'router.get('
      - 'router.post('

# Skip rules - when to skip certain CI steps
skipRules:
  # Skip database tests if no DB-related changes
  database:
    skipWhen:
      - pattern: 'documentation'
        only: true
      - pattern: 'styles'
        only: true
      - pattern: 'config'
        only: true
    runWhen:
      - pattern: 'database'
      - pattern: 'code'
        hasKeyword: 'database'
      - pattern: 'api'

  # Skip Redis tests if no cache-related changes
  redis:
    skipWhen:
      - pattern: 'documentation'
        only: true
      - pattern: 'styles'
        only: true
      - pattern: 'database'
        only: true
    runWhen:
      - pattern: 'cache'
      - pattern: 'code'
        hasKeyword: 'cache'

  # Skip integration tests for minor changes
  integration:
    skipWhen:
      - pattern: 'documentation'
        only: true
      - pattern: 'tests'
        only: true
      - pattern: 'styles'
        only: true
      - pattern: 'config'
        only: true
    runWhen:
      - pattern: 'api'
      - pattern: 'database'
      - pattern: 'infrastructure'

  # Skip E2E tests for backend-only changes
  e2e:
    skipWhen:
      - pattern: 'documentation'
        only: true
      - pattern: 'database'
        only: true
      - pattern: 'infrastructure'
        only: true
      - pattern: 'config'
        only: true
    runWhen:
      - pattern: 'code'
      - pattern: 'api'
      - pattern: 'styles'

# Build scope determination
buildScope:
  none:
    - pattern: 'documentation'
      only: true

  minimal:
    - pattern: 'styles'
      only: true
    - pattern: 'config'
      only: true
    - pattern: 'tests'
      only: true

  partial:
    - pattern: 'code'
      limited: true
    - filesChanged: '<10'

  full:
    - pattern: 'infrastructure'
    - pattern: 'dependencies'
    - pattern: 'database'
    - pattern: 'api'
    - filesChanged: '>=10'

# Optimization thresholds
optimization:
  # Expected time savings (seconds)
  estimatedTimeSavings:
    skipDatabase: 45
    skipRedis: 30
    skipIntegration: 120
    skipE2E: 180
    documentationOnly: 300

  # Expected cost savings (percentage)
  estimatedCostSavings:
    skipDatabase: 15
    skipRedis: 10
    skipIntegration: 30
    skipE2E: 40
    documentationOnly: 90
