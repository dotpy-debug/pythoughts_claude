# Pythoughts Platform - Deployment Guide

Complete guide for deploying the Pythoughts platform to production environments.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Environment Setup](#environment-setup)
- [Deployment Options](#deployment-options)
  - [Vercel Deployment](#vercel-deployment)
  - [Railway Deployment](#railway-deployment)
  - [Docker Deployment](#docker-deployment)
- [Database Setup](#database-setup)
- [CI/CD Pipeline](#cicd-pipeline)
- [Monitoring and Logging](#monitoring-and-logging)
- [Troubleshooting](#troubleshooting)
- [Rollback Procedures](#rollback-procedures)

---

## Prerequisites

Before deploying, ensure you have:

- **Node.js 20+** installed locally
- **Git** for version control
- **Docker** (optional, for containerized deployment)
- **Supabase account** for PostgreSQL and authentication
- **Redis instance** (Redis Cloud, Upstash, or self-hosted)
- **Domain name** (optional, for custom domains)

## Environment Setup

### Required Environment Variables

Create a `.env.production` file with the following variables:

```bash
# Application
NODE_ENV=production
VITE_APP_URL=https://your-domain.com

# Supabase Configuration
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

# API Configuration
VITE_API_URL=https://api.your-domain.com

# Redis Configuration (if self-hosting)
REDIS_URL=redis://username:password@host:port

# Optional: Analytics
VITE_SENTRY_DSN=your-sentry-dsn
VITE_ANALYTICS_ID=your-analytics-id
```

### Security Checklist

- [ ] All secrets stored in environment variables
- [ ] `.env` files added to `.gitignore`
- [ ] API keys rotated from development values
- [ ] CORS configured for production domains only
- [ ] CSP headers configured in production
- [ ] HTTPS enforced on all endpoints

---

## Deployment Options

### Vercel Deployment

**Recommended for quick, zero-config deployments.**

#### 1. Install Vercel CLI

```bash
npm install -g vercel
```

#### 2. Login to Vercel

```bash
vercel login
```

#### 3. Deploy

```bash
# First deployment (follow prompts)
vercel

# Production deployment
vercel --prod
```

#### 4. Configure Environment Variables

In Vercel Dashboard:
1. Go to **Project Settings** → **Environment Variables**
2. Add all required variables from `.env.production`
3. Set scope to **Production**

#### 5. Custom Domain Setup

1. Go to **Project Settings** → **Domains**
2. Add your custom domain
3. Configure DNS records as instructed
4. Wait for SSL certificate provisioning

**Deploy Command:**
```bash
vercel --prod
```

**Deployment URL:** Automatically generated by Vercel

---

### Railway Deployment

**Best for full-stack applications with database and Redis.**

#### 1. Install Railway CLI

```bash
npm install -g @railway/cli
```

#### 2. Login to Railway

```bash
railway login
```

#### 3. Initialize Project

```bash
railway init
```

#### 4. Add Services

```bash
# Add PostgreSQL
railway add postgresql

# Add Redis
railway add redis
```

#### 5. Configure Environment

```bash
railway variables set VITE_SUPABASE_URL=your-supabase-url
railway variables set VITE_SUPABASE_ANON_KEY=your-anon-key
```

#### 6. Deploy

```bash
railway up
```

**Configuration:** Railway auto-detects `nixpacks.toml`

---

### Docker Deployment

**For self-hosted or cloud VPS deployments.**

#### 1. Build Docker Image

```bash
# Build production image
docker build -t pythoughts:latest --target production .

# Build with build args
docker build -t pythoughts:latest \
  --build-arg VITE_SUPABASE_URL=https://your-project.supabase.co \
  --build-arg VITE_SUPABASE_ANON_KEY=your-anon-key \
  --target production .
```

#### 2. Run Container

```bash
docker run -d \
  -p 3000:3000 \
  --name pythoughts-app \
  --env-file .env.production \
  pythoughts:latest
```

#### 3. Using Docker Compose

```bash
# Start all services (app, PostgreSQL, Redis)
docker-compose up -d

# View logs
docker-compose logs -f app

# Stop services
docker-compose down
```

#### 4. Production Docker Compose

Create `docker-compose.prod.yml`:

```yaml
version: '3.9'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: production
    env_file:
      - .env.production
    restart: unless-stopped
```

Deploy:
```bash
docker-compose -f docker-compose.prod.yml up -d
```

---

## Database Setup

### Supabase Configuration

#### 1. Create Supabase Project

1. Go to [Supabase Dashboard](https://app.supabase.com)
2. Click **New Project**
3. Configure database settings
4. Wait for provisioning

#### 2. Run Migrations

If you have database migrations:

```bash
# Install Supabase CLI
npm install -g supabase

# Link to your project
supabase link --project-ref your-project-ref

# Run migrations
supabase db push
```

#### 3. Configure Row Level Security (RLS)

Enable RLS on all tables:

```sql
-- Example: Enable RLS on posts table
ALTER TABLE posts ENABLE ROW LEVEL SECURITY;

-- Create policy
CREATE POLICY "Users can view published posts"
ON posts FOR SELECT
USING (is_published = true OR auth.uid() = author_id);
```

#### 4. Create Indexes

For optimal performance:

```sql
-- Trending posts index
CREATE INDEX idx_posts_trending
ON posts (trending_score DESC, created_at DESC);

-- User posts index
CREATE INDEX idx_posts_author
ON posts (author_id, created_at DESC);

-- Full-text search
CREATE INDEX idx_posts_search
ON posts USING GIN (to_tsvector('english', title || ' ' || content));
```

### Redis Setup

#### Option 1: Upstash (Recommended)

1. Create account at [Upstash](https://upstash.com)
2. Create Redis database
3. Copy connection string
4. Add to environment variables

#### Option 2: Redis Cloud

1. Create account at [Redis Cloud](https://redis.com/redis-enterprise-cloud/overview/)
2. Create database
3. Configure and copy credentials

#### Option 3: Self-Hosted

```bash
# Using Docker
docker run -d \
  -p 6379:6379 \
  --name pythoughts-redis \
  redis:7-alpine \
  redis-server --appendonly yes
```

---

## CI/CD Pipeline

### GitHub Actions

The repository includes two workflows:

#### 1. CI Pipeline (`.github/workflows/ci.yml`)

Runs on every PR and push to `main`:
- Code linting
- Type checking
- Unit tests with coverage
- E2E tests
- Build verification
- Security scanning

#### 2. Deployment Pipeline (`.github/workflows/deploy.yml`)

Runs on push to `main`:
- Pre-deployment validation
- Production build
- Deploy to Vercel/Railway
- Database migrations (if enabled)
- Post-deployment smoke tests
- Automatic rollback on failure

### Required GitHub Secrets

Configure in **Repository Settings** → **Secrets**:

```bash
# Vercel
VERCEL_TOKEN
VERCEL_ORG_ID
VERCEL_PROJECT_ID

# Railway
RAILWAY_TOKEN

# Supabase
VITE_SUPABASE_URL
VITE_SUPABASE_ANON_KEY

# Optional
CODECOV_TOKEN
SNYK_TOKEN
SENTRY_AUTH_TOKEN
```

### Manual Deployment

Trigger deployment manually:

```bash
# Using GitHub CLI
gh workflow run deploy.yml

# Or via GitHub UI
# Actions → Production Deployment → Run workflow
```

---

## Monitoring and Logging

### Application Monitoring

#### Sentry Integration

```typescript
// src/lib/sentry.ts
import * as Sentry from '@sentry/react';

Sentry.init({
  dsn: import.meta.env.VITE_SENTRY_DSN,
  environment: import.meta.env.NODE_ENV,
  tracesSampleRate: 1.0,
});
```

#### Vercel Analytics

Automatically enabled in Vercel deployments.

### Performance Monitoring

Monitor key metrics:
- **Page Load Time**: < 2 seconds
- **Time to Interactive**: < 3 seconds
- **Core Web Vitals**: LCP, FID, CLS
- **API Response Time**: < 500ms
- **Cache Hit Rate**: > 80%

### Log Aggregation

#### Production Logs

```bash
# Vercel logs
vercel logs

# Railway logs
railway logs

# Docker logs
docker logs pythoughts-app -f
```

#### Custom Logging

```typescript
// src/lib/logger.ts
export const logger = {
  info: (message: string, meta?: any) => {
    console.log(`[INFO] ${message}`, meta);
  },
  error: (message: string, error?: Error) => {
    console.error(`[ERROR] ${message}`, error);
    // Send to Sentry
    Sentry.captureException(error);
  },
};
```

---

## Troubleshooting

### Common Issues

#### 1. Build Fails with Memory Error

**Solution:** Increase Node.js memory

```bash
# In package.json
"build": "NODE_OPTIONS=--max-old-space-size=4096 vite build"
```

#### 2. Environment Variables Not Loading

**Solution:** Check environment variable prefix

- Vite requires `VITE_` prefix for client-side variables
- Rebuild after changing variables

#### 3. CORS Errors

**Solution:** Configure CORS in API

```typescript
// Add allowed origins
const allowedOrigins = [
  'https://your-domain.com',
  'https://www.your-domain.com',
];
```

#### 4. Redis Connection Timeout

**Solution:** Check Redis URL format

```bash
# Correct format
redis://username:password@host:port

# With TLS
rediss://username:password@host:port
```

#### 5. Database Connection Pool Exhausted

**Solution:** Optimize connection pooling

```typescript
// In Supabase client
const supabase = createClient(url, key, {
  db: {
    pool: { max: 10, min: 2 },
  },
});
```

### Health Checks

Test deployment health:

```bash
# Health endpoint
curl https://your-domain.com/api/health

# Database connection
curl https://your-domain.com/api/health/db

# Redis connection
curl https://your-domain.com/api/health/redis
```

---

## Rollback Procedures

### Vercel Rollback

```bash
# List deployments
vercel ls

# Rollback to specific deployment
vercel rollback [deployment-url]

# Or via UI: Deployments → Select previous → Promote to Production
```

### Railway Rollback

```bash
# View deployment history
railway deployments

# Rollback to previous
railway rollback
```

### Docker Rollback

```bash
# Stop current container
docker stop pythoughts-app

# Start previous version
docker run -d \
  -p 3000:3000 \
  --name pythoughts-app \
  pythoughts:previous-tag
```

### Database Rollback

```sql
-- Rollback last migration
supabase db reset

-- Or manually restore from backup
pg_restore -d pythoughts_prod backup.sql
```

---

## Post-Deployment Checklist

- [ ] All environment variables configured
- [ ] Database migrations applied
- [ ] Health checks passing
- [ ] SSL certificate active
- [ ] Custom domain configured
- [ ] Analytics tracking verified
- [ ] Error tracking configured
- [ ] Backup strategy in place
- [ ] Monitoring dashboards setup
- [ ] Team access configured

---

## Performance Optimization

### Build Optimization

```bash
# Analyze bundle size
npm run build -- --analyze

# Tree shaking
npm run build -- --minify
```

### Caching Strategy

- **Static Assets**: 1 year cache
- **HTML**: 5 minutes cache
- **API Responses**: 5 minutes cache (Redis)
- **Database Queries**: 5 minutes cache (Materialized views)

### CDN Configuration

Enable CDN for static assets:
- **Vercel**: Automatic edge caching
- **Railway**: Configure CDN in settings
- **Custom**: CloudFlare or AWS CloudFront

---

## Support and Resources

- **Documentation**: [Pythoughts Docs](https://docs.pythoughts.com)
- **GitHub Issues**: [Report bugs](https://github.com/pythoughts/platform/issues)
- **Community**: [Discord](https://discord.gg/pythoughts)
- **Email**: support@pythoughts.com

---

**Last Updated:** January 2025
**Version:** 1.0.0
